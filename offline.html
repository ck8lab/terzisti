<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Offline Control</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { display:flex; justify-content:center; align-items:center; height:100vh; background:#f8f9fa; margin:0; }
.container { text-align:center; }
#statusIndicator { font-size:1.2rem; margin-top:10px; }
</style>
</head>
<body>

<div class="container">
  <h2>Modalit√† Offline</h2>
  <button id="toggleBtn" class="btn btn-primary mt-3">Attiva / Disattiva Offline</button>
  <div id="statusIndicator"></div>
  <div id="alert-container" class="mt-3"></div>
</div>

<!-- Modal per inserimento codice numerico -->
<div class="modal fade" id="codiceModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Inserisci il codice di sicurezza</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="number" id="codiceInput" class="form-control" placeholder="Numero di sicurezza">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="verificaCodiceBtn">Verifica</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCpMPomzyMgkmtLgfjvwA_j1zTIz-vpFKA",
  authDomain: "terzisti-2a23f.firebaseapp.com",
  databaseURL: "https://terzisti-2a23f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "terzisti-2a23f",
  storageBucket: "terzisti-2a23f.firebasestorage.app",
  messagingSenderId: "304632997223",
  appId: "1:304632997223:web:0741bb6a9e643d8bacfbc2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const statoRef = ref(db, "stato");

// Funzione per alert
function showAlert(msg,type="success"){
  const container = document.getElementById("alert-container");
  container.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
  setTimeout(()=>{ const a=container.querySelector(".alert"); if(a) bootstrap.Alert.getOrCreateInstance(a).close(); },5000);
}

// Aggiorna indicatore stato
function updateStatusIndicator(attivita){
  const statusEl = document.getElementById("statusIndicator");
  if(attivita){
    statusEl.textContent = "Sito ONLINE üü©";
    statusEl.className = "text-success";
  } else {
    statusEl.textContent = "Sito OFFLINE üü•";
    statusEl.className = "text-danger";
  }
}

// Legge stato iniziale e aggiorna in tempo reale
onValue(statoRef, (snap)=>{
  if(snap.exists()){
    updateStatusIndicator(snap.val().attivita);
  }
});

// Mostra modal numerico al click
document.getElementById("toggleBtn").addEventListener("click", () => {
  const modal = new bootstrap.Modal(document.getElementById("codiceModal"));
  modal.show();
});

// Verifica codice e toggle offline
document.getElementById("verificaCodiceBtn").addEventListener("click", async () => {
  const codiceInserito = Number(document.getElementById("codiceInput").value);
  if(!codiceInserito) return;

  const snap = await get(statoRef);
  if(!snap.exists()){ showAlert("Errore: nodo stato non trovato","danger"); return; }
  const data = snap.val();

  if(codiceInserito === data.codice){
    const nuovoStato = !data.attivita;
    await set(statoRef, {...data, attivita: nuovoStato});
    showAlert(`Modalit√† offline ${(nuovoStato ? "attivata" : "disattivata")}`);
    updateStatusIndicator(nuovoStato);
    bootstrap.Modal.getInstance(document.getElementById("codiceModal")).hide();
  } else {
    showAlert("Codice errato!","danger");
  }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
