<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestione Terzisti - Utente</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
html,body{height:100%;margin:0;padding:0;}
body{padding-top:70px;min-height:100%;display:flex;flex-direction:column;}
main{flex:1;background:#f8f9fa;}
.empty-placeholder{text-align:center;color:#aaa;font-size:1.2rem;margin-top:50px;}
.btn-group-vertical{display:flex;flex-direction:row !important;gap:0.3rem;}
table td{vertical-align:middle;}
footer{background:#1a1a1a;color:#fff;text-align:center;padding:1rem;}
footer a{color:#ffcc00;text-decoration:none;}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Gestione Terzisti</a>
    <div class="d-flex">
      <button class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#formModal">Inserisci Dati</button>
      <button class="btn btn-danger me-2" id="clearDb">Svuota Database</button>
      <a class="btn btn-warning me-2" href="admin.html">Admin</a>
      <button class="btn btn-secondary ms-2" id="logoutBtn">Logout</button>
    </div>
  </div>
</nav>

<main class="container mt-4">
  <div id="alert-container"></div>
  <div id="tables-container" class="mt-4"></div>
</main>

<!-- Modal Inserimento / Modifica -->
<div class="modal fade" id="formModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Inserisci Dati</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="dataForm">
          <input type="hidden" id="editingId" value="">
          <div class="mb-3">
            <label class="form-label">Terzista</label>
            <div class="input-group">
              <input type="text" id="searchTerzista" class="form-control" placeholder="Cerca terzista...">
              <select id="terzista" class="form-select"><option value="">---</option></select>
            </div>
          </div>
          <div class="mb-3"><input type="number" id="odl" class="form-control" placeholder="ODL" required></div>
          <div class="mb-3"><input type="number" id="pezzi" class="form-control" placeholder="Pezzi (opzionale)"></div>
          <div class="mb-3"><input type="number" id="gabbie" class="form-control" placeholder="Gabbie (opzionale)"></div>
          <div class="mb-3"><textarea id="descrizione" class="form-control" placeholder="Descrizione (opzionale)"></textarea></div>
          <div class="mb-3">
            <label class="form-label">Stato</label>
            <select id="stato" class="form-select" required>
              <option value="DA AUTORIZZARE">DA AUTORIZZARE</option>
              <option value="IN ATTESA">IN ATTESA</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary w-100">Salva</button>
        </form>
      </div>
    </div>
  </div>
</div>

<footer>
  <p class="mb-0">Sito web realizzato da <a href="https://ck8lab.github.io/kevincellura/" target="_blank">CK8LAB</a></p>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, push, set, get, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCpMPomzyMgkmtLgfjvwA_j1zTIz-vpFKA",
  authDomain: "terzisti-2a23f.firebaseapp.com",
  databaseURL: "https://terzisti-2a23f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "terzisti-2a23f",
  storageBucket: "terzisti-2a23f.firebasestorage.app",
  messagingSenderId: "304632997223",
  appId: "1:304632997223:web:0741bb6a9e643d8bacfbc2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const datiRef = ref(db,"terzisti");
const terzistiListRef = ref(db,"terzistiList");
const siteStatusRef = ref(db,"siteStatus/online");

// Controlla online
async function checkOnlineStatus(){ 
  const snap = await get(siteStatusRef);
  if(!snap.exists() || snap.val()===false){ window.location.href="ops.html"; }
}

// Login obbligatorio
onAuthStateChanged(auth, async user=>{
  if(!user) window.location.href="login.html";
  else await checkOnlineStatus();
});

document.getElementById("logoutBtn").addEventListener("click",async()=>{await signOut(auth); window.location.href="login.html";});

// Alert
function showAlert(msg,type="success"){
  const c=document.getElementById("alert-container");
  c.innerHTML=`<div class="alert alert-${type} alert-dismissible fade show">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
  setTimeout(()=>{ const a=c.querySelector(".alert"); if(a) bootstrap.Alert.getOrCreateInstance(a).close(); },5000);
}

// Carica terzisti select
async function loadTerzistiSelect(){
  const snap = await get(terzistiListRef);
  const sel = document.getElementById("terzista");
  sel.innerHTML = `<option value="">---</option>`;
  if(snap.exists()) Object.keys(snap.val()).forEach(t=> sel.innerHTML+=`<option value="${t}">${t}</option>`);
}

// Carica dati tabella
async function loadTables(){
  const snap = await get(datiRef);
  const div = document.getElementById("tables-container");
  div.innerHTML="";
  if(!snap.exists()){ div.innerHTML=`<div class="empty-placeholder">Nessun dato disponibile</div>`; return; }
  const data = snap.val();
  const grouped = {};
  Object.keys(data).forEach(id=>{
    const row = data[id];
    if(!grouped[row.terzista]) grouped[row.terzista]=[];
    grouped[row.terzista].push({...row,id});
  });

  Object.keys(grouped).sort().forEach(t=>{
    let html=`<div class="card mb-3"><div class="card-body d-flex justify-content-between align-items-center"><h5>${t}</h5>
    <button class="btn btn-sm btn-danger" onclick="deleteTerzista('${t}')">üóë Elimina Tutti i Dati</button></div>
    <table class="table table-striped table-responsive"><thead><tr>
    <th>ODL</th><th>Pezzi</th><th>Gabbie</th><th>Descrizione</th><th>Stato</th><th>Azioni</th>
    </tr></thead><tbody>`;
    grouped[t].forEach(r=>{
      html+=`<tr>
      <td>${r.odl||"&nbsp;"}</td>
      <td>${r.pezzi||"&nbsp;"}</td>
      <td>${r.gabbie||"&nbsp;"}</td>
      <td>${r.descrizione||"&nbsp;"}</td>
      <td>${r.stato||"DA AUTORIZZARE"}</td>
      <td><div class="btn-group-vertical">
        <button class="btn btn-sm btn-warning" onclick="editRow('${r.id}')">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-danger" onclick="deleteRow('${r.id}')">üóë</button>
      </div></td></tr>`;
    });
    html+=`</tbody></table></div>`;
    div.innerHTML+=html;
  });
}

window.editRow=async id=>{
  const snap = await get(ref(db,`terzisti/${id}`));
  if(!snap.exists()) return;
  const row = snap.val();
  document.getElementById("modalTitle").innerText="Modifica Dati";
  document.getElementById("editingId").value=id;
  document.getElementById("terzista").value=row.terzista||"";
  document.getElementById("searchTerzista").value=row.terzista||"";
  document.getElementById("odl").value=row.odl||"";
  document.getElementById("pezzi").value=row.pezzi||"";
  document.getElementById("gabbie").value=row.gabbie||"";
  document.getElementById("descrizione").value=row.descrizione||"";
  document.getElementById("stato").value=row.stato||"DA AUTORIZZARE";
  new bootstrap.Modal(document.getElementById("formModal")).show();
};

window.deleteRow=async id=>{
  if(confirm("‚ö† Vuoi davvero eliminare questo record?")){
    await remove(ref(db,`terzisti/${id}`));
    showAlert("Record eliminato!","warning");
    loadTables();
  }
};

window.deleteTerzista=async t=>{
  if(confirm(`‚ö† Vuoi davvero eliminare tutti i dati di ${t}?`)){
    const snap = await get(datiRef);
    if(!snap.exists()) return;
    const data = snap.val();
    for(const id in data) if(data[id].terzista===t) await remove(ref(db,`terzisti/${id}`));
    showAlert(`Tutti i dati di ${t} eliminati!`,"warning");
    loadTables();
  }
};

document.getElementById("dataForm").addEventListener("submit",async e=>{
  e.preventDefault();
  const id = document.getElementById("editingId").value;
  const payload = {
    terzista: document.getElementById("terzista").value,
    odl: document.getElementById("odl").value,
    pezzi: document.getElementById("pezzi").value||"",
    gabbie: document.getElementById("gabbie").value||"",
    descrizione: document.getElementById("descrizione").value||"",
    stato: document.getElementById("stato").value
  };
  if(!payload.terzista || !payload.odl){ showAlert("Terzista e ODL obbligatori!","danger"); return; }
  if(id) await set(ref(db,`terzisti/${id}`),payload), showAlert("Record aggiornato!");
  else await push(datiRef,payload), showAlert("Record aggiunto!");
  const modal = bootstrap.Modal.getInstance(document.getElementById("formModal")); modal.hide();
  e.target.reset(); document.getElementById("editingId").value="";
  loadTables();
});

document.getElementById("clearDb").addEventListener("click",async()=>{
  if(confirm("‚ö† Vuoi davvero svuotare tutto il database?")){
    await set(datiRef,null);
    showAlert("Database svuotato!","warning");
    loadTables();
  }
});

loadTerzistiSelect();
loadTables();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
