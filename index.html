<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestione Terzisti - Utente</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/jpeg" href="favicon.jpg">
  <style>
    .empty-placeholder {
      text-align: center;
      color: #aaa;
      font-size: 1.2rem;
      margin-top: 50px;
    }
    .input-group select {
      max-width: 200px;
    }
  </style>
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Gestione Terzisti</a>
    <div class="d-flex">
      <button class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#formModal">Inserisci Dati</button>
      <button class="btn btn-danger me-2" id="clearDb">Svuota Database</button>
      <a href="admin.html" class="btn btn-warning">Admin</a>
    </div>
  </div>
</nav>

<div class="container mt-5 pt-4">
  <div id="alert-container"></div>
  <div id="tables-container" class="mt-4"></div>
</div>

<!-- Modal Inserimento -->
<div class="modal fade" id="formModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Inserisci Dati</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="dataForm">
          <!-- Terzista con ricerca integrata -->
          <div class="mb-3">
            <label class="form-label">Terzista</label>
            <div class="input-group">
              <input type="text" id="searchTerzista" class="form-control" placeholder="Cerca terzista...">
              <select id="terzista" class="form-select" size="1">
                <option value="">---</option>
              </select>
            </div>
          </div>

          <div class="mb-3"><input type="number" id="odl" class="form-control" placeholder="ODL" required></div>
          <div class="mb-3"><input type="number" id="pezzi" class="form-control" placeholder="Pezzi (opzionale)"></div>
          <div class="mb-3"><input type="number" id="gabbie" class="form-control" placeholder="Gabbie (opzionale)"></div>
          <div class="mb-3">
            <textarea id="descrizione" class="form-control" placeholder="Descrizione (opzionale)"></textarea>
          </div>
          <div class="mb-3"><input type="date" id="dataInserimento" class="form-control" required></div>
          <div class="mb-3">
            <label class="form-label">Stato</label>
            <select id="stato" class="form-select" required>
              <option value="DA AUTORIZZARE">DA AUTORIZZARE</option>
              <option value="IN ATTESA">IN ATTESA</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary w-100">Salva</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, push, set, get, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

// ðŸ”¹ Config Firebase
const firebaseConfig = {
  apiKey: "TUO_API_KEY",
  authDomain: "terzisti-2a23f.firebaseapp.com",
  databaseURL: "https://terzisti-2a23f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "terzisti-2a23f",
  storageBucket: "terzisti-2a23f.firebasestorage.app",
  messagingSenderId: "304632997223",
  appId: "1:304632997223:web:0741bb6a9e643d8bacfbc2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const terzistiListRef = ref(db, "terzistiList");
const datiRef = ref(db, "terzisti");

// ðŸ”¹ Utility alert
function showAlert(msg, type="success") {
  const c = document.getElementById("alert-container");
  c.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show">${msg}
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
}

// ðŸ”¹ Carica lista terzisti con prima opzione "---"
async function loadTerzisti() {
  const snap = await get(terzistiListRef);
  const sel = document.getElementById("terzista");
  sel.innerHTML = `<option value="">---</option>`; // prima opzione nulla
  if (snap.exists()) {
    Object.keys(snap.val()).forEach(t => {
      sel.innerHTML += `<option value="${t}">${t}</option>`;
    });
  }
}

// ðŸ”¹ Barra di ricerca integrata
const searchInput = document.getElementById("searchTerzista");
const terzistaSelect = document.getElementById("terzista");

searchInput.addEventListener("input", function() {
  const filter = this.value.toLowerCase();
  for (let i = 0; i < terzistaSelect.options.length; i++) {
    const txt = terzistaSelect.options[i].text.toLowerCase();
    terzistaSelect.options[i].style.display = txt.includes(filter) ? "" : "none";
  }
});

// Aggiorna barra di ricerca solo se un terzista Ã¨ selezionato
terzistaSelect.addEventListener("change", function() {
  const selectedText = terzistaSelect.options[terzistaSelect.selectedIndex].text;
  if(selectedText !== "---") searchInput.value = selectedText;
});

// ðŸ”¹ Carica dati in tabelle
async function loadTables() {
  const snap = await get(datiRef);
  const div = document.getElementById("tables-container");
  div.innerHTML = "";

  if (!snap.exists()) {
    div.innerHTML = `<div class="empty-placeholder">Nessun dato disponibile</div>`;
    return;
  }

  const data = snap.val();
  const grouped = {};
  Object.keys(data).forEach(id => {
    const row = data[id];
    if (!grouped[row.terzista]) grouped[row.terzista] = [];
    grouped[row.terzista].push({ ...row, id });
  });

  Object.keys(grouped).forEach(t => {
    let html = `<div class="card mb-3"><div class="card-body"><h5>${t}</h5>
      <table class="table table-striped"><thead><tr>
      <th>ODL</th><th>Pezzi</th><th>Gabbie</th><th>Descrizione</th><th>Data</th><th>Stato</th><th>Azioni</th>
      </tr></thead><tbody>`;
    grouped[t].forEach(r => {
      html += `<tr>
        <td>${r.odl}</td><td>${r.pezzi||""}</td><td>${r.gabbie||""}</td>
        <td>${r.descrizione||""}</td><td>${r.data}</td><td>${r.stato||"DA AUTORIZZARE"}</td>
        <td><button class="btn btn-sm btn-danger" onclick="deleteRow('${r.id}')">ðŸ—‘</button></td>
      </tr>`;
    });
    html += `</tbody></table></div></div>`;
    div.innerHTML += html;
  });
}

// ðŸ”¹ Elimina singola riga
window.deleteRow = async (id) => {
  if (confirm("âš  Vuoi davvero eliminare questo record?")) {
    await remove(ref(db, `terzisti/${id}`));
    showAlert("Record eliminato!", "warning");
    loadTables();
  }
};

// ðŸ”¹ Svuota database
document.getElementById("clearDb").addEventListener("click", async () => {
  if (confirm("âš  Vuoi davvero SVUOTARE TUTTO il database?")) {
    await remove(datiRef);
    showAlert("Database svuotato!", "danger");
    loadTables();
  }
});

// ðŸ”¹ Salvataggio form
document.getElementById("dataForm").addEventListener("submit", async e => {
  e.preventDefault();
  const data = {
    terzista: document.getElementById("terzista").value,
    odl: document.getElementById("odl").value,
    pezzi: document.getElementById("pezzi").value || "",
    gabbie: document.getElementById("gabbie").value || "",
    descrizione: document.getElementById("descrizione").value || "",
    data: document.getElementById("dataInserimento").value,
    stato: document.getElementById("stato").value
  };
  await set(push(datiRef), data);
  showAlert("Dati inseriti con successo!");
  e.target.reset();
  setDefaultDate();
  loadTables();
});

// ðŸ”¹ Imposta data di default oggi
function setDefaultDate() {
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("dataInserimento").value = today;
}

loadTerzisti();
loadTables();
setDefaultDate();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
