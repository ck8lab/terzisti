<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestione Terzisti - Utente</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" type="image/jpeg" href="favicon.jpg">
<style>
  body { padding-top: 70px; background-color: #f8f9fa; }
  .empty-placeholder { text-align: center; color: #aaa; font-size: 1.2rem; margin-top: 50px; }
  .btn-group-vertical { display: flex; flex-direction: row !important; gap: 0.3rem; }
  table td { vertical-align: middle; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Gestione Terzisti</a>
    <div class="d-flex">
      <button class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#formModal">Inserisci Dati</button>
      <button class="btn btn-danger me-2" id="clearDb">Svuota Database</button>
      <a href="admin.html" class="btn btn-warning">Admin</a>
    </div>
  </div>
</nav>

<div class="container mt-5 pt-4">
  <div id="alert-container"></div>
  <div id="tables-container" class="mt-4"></div>
</div>

<!-- Modal Inserimento / Modifica -->
<div class="modal fade" id="formModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Inserisci Dati</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="dataForm">
          <input type="hidden" id="editingId" value="">
          <div class="mb-3">
            <label class="form-label">Terzista</label>
            <div class="input-group">
              <input type="text" id="searchTerzista" class="form-control" placeholder="Cerca terzista...">
              <select id="terzista" class="form-select" size="1">
                <option value="">---</option>
              </select>
            </div>
          </div>

          <div class="mb-3"><input type="number" id="odl" class="form-control" placeholder="ODL" required></div>
          <div class="mb-3"><input type="number" id="pezzi" class="form-control" placeholder="Pezzi (opzionale)"></div>
          <div class="mb-3"><input type="number" id="gabbie" class="form-control" placeholder="Gabbie (opzionale)"></div>
          <div class="mb-3">
            <textarea id="descrizione" class="form-control" placeholder="Descrizione (opzionale)"></textarea>
          </div>
          <div class="mb-3"><input type="date" id="dataInserimento" class="form-control" required></div>
          <div class="mb-3">
            <label class="form-label">Stato</label>
            <select id="stato" class="form-select" required>
              <option value="DA AUTORIZZARE">DA AUTORIZZARE</option>
              <option value="IN ATTESA">IN ATTESA</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary w-100">Salva</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, push, set, get, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

// üîπ Config Firebase
const firebaseConfig = {
  apiKey: "TUO_API_KEY",
  authDomain: "terzisti-2a23f.firebaseapp.com",
  databaseURL: "https://terzisti-2a23f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "terzisti-2a23f",
  storageBucket: "terzisti-2a23f.firebasestorage.app",
  messagingSenderId: "304632997223",
  appId: "1:304632997223:web:0741bb6a9e643d8bacfbc2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const terzistiListRef = ref(db, "terzistiList");
const datiRef = ref(db, "terzisti");

// üîπ Alert
function showAlert(msg, type="success") {
  const c = document.getElementById("alert-container");
  c.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show">${msg}
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
}

// üîπ Carica terzisti
async function loadTerzisti() {
  const snap = await get(terzistiListRef);
  const sel = document.getElementById("terzista");
  sel.innerHTML = `<option value="">---</option>`;
  if (snap.exists()) {
    Object.keys(snap.val()).forEach(t => sel.innerHTML += `<option value="${t}">${t}</option>`);
  }
}

// üîπ Barra ricerca
const searchInput = document.getElementById("searchTerzista");
const terzistaSelect = document.getElementById("terzista");
searchInput.addEventListener("input", () => {
  const filter = searchInput.value.toLowerCase();
  for (let i=0;i<terzistaSelect.options.length;i++){
    const txt = terzistaSelect.options[i].text.toLowerCase();
    terzistaSelect.options[i].style.display = txt.includes(filter) ? "" : "none";
  }
});
terzistaSelect.addEventListener("change", () => {
  const text = terzistaSelect.options[terzistaSelect.selectedIndex].text;
  if(text !== "---") searchInput.value = text;
});

// üîπ Formatta data
function formatDate(d) {
  if (!d) return "";
  const date = new Date(d);
  const gg = String(date.getDate()).padStart(2,'0');
  const mm = String(date.getMonth()+1).padStart(2,'0');
  const yyyy = date.getFullYear();
  return `${gg}/${mm}/${yyyy}`;
}

// üîπ Carica tabelle
async function loadTables() {
  const snap = await get(datiRef);
  const div = document.getElementById("tables-container");
  div.innerHTML = "";

  if (!snap.exists()) {
    div.innerHTML = `<div class="empty-placeholder">Nessun dato disponibile</div>`;
    return;
  }

  const data = snap.val();
  const grouped = {};
  Object.keys(data).forEach(id => {
    const row = data[id];
    if(!grouped[row.terzista]) grouped[row.terzista] = [];
    grouped[row.terzista].push({...row, id});
  });

  Object.keys(grouped).forEach(t => {
    let html = `<div class="card mb-3"><div class="card-body"><h5>${t}</h5>
    <table class="table table-striped table-responsive"><thead><tr>
    <th>ODL</th><th>Pezzi</th><th>Gabbie</th><th>Descrizione</th><th>Data</th><th>Stato</th><th>Azioni</th>
    </tr></thead><tbody>`;

    grouped[t].forEach(r => {
      html += `<tr>
        <td>${r.odl || "&nbsp;"}</td>
        <td>${r.pezzi || "&nbsp;"}</td>
        <td>${r.gabbie || "&nbsp;"}</td>
        <td>${r.descrizione || "&nbsp;"}</td>
        <td>${formatDate(r.data)}</td>
        <td>${r.stato || "DA AUTORIZZARE"}</td>
        <td>
          <div class="btn-group-vertical">
            <button class="btn btn-sm btn-warning" onclick="editRow('${r.id}')">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="deleteRow('${r.id}')">üóë</button>
          </div>
        </td>
      </tr>`;
    });

    html += `</tbody></table></div></div>`;
    div.innerHTML += html;
  });
}

// üîπ Edit row
window.editRow = async (id) => {
  const snap = await get(ref(db, `terzisti/${id}`));
  if (!snap.exists()) return;
  const row = snap.val();

  document.getElementById("modalTitle").innerText = "Modifica Dati";
  document.getElementById("editingId").value = id;
  document.getElementById("terzista").value = row.terzista || "";
  searchInput.value = row.terzista || "";
  document.getElementById("odl").value = row.odl || "";
  document.getElementById("pezzi").value = row.pezzi || "";
  document.getElementById("gabbie").value = row.gabbie || "";
  document.getElementById("descrizione").value = row.descrizione || "";
  document.getElementById("dataInserimento").value = row.data || "";
  document.getElementById("stato").value = row.stato || "DA AUTORIZZARE";

  const modal = new bootstrap.Modal(document.getElementById("formModal"));
  modal.show();
};

// üîπ Delete row
window.deleteRow = async (id) => {
  if(confirm("‚ö† Vuoi davvero eliminare questo record?")){
    await remove(ref(db, `terzisti/${id}`));
    showAlert("Record eliminato!", "warning");
    loadTables();
  }
};

// üîπ Clear DB
document.getElementById("clearDb").addEventListener("click", async () => {
  if(confirm("‚ö† Vuoi davvero svuotare tutto il database?")){
    await remove(datiRef);
    showAlert("Database svuotato!", "danger");
    loadTables();
  }
});

// üîπ Save form
document.getElementById("dataForm").addEventListener("submit", async e => {
  e.preventDefault();
  const id = document.getElementById("editingId").value;
  const data = {
    terzista: document.getElementById("terzista").value,
    odl: document.getElementById("odl").value,
    pezzi: document.getElementById("pezzi").value || "",
    gabbie: document.getElementById("gabbie").value || "",
    descrizione: document.getElementById("descrizione").value || "",
    data: document.getElementById("dataInserimento").value,
    stato: document.getElementById("stato").value
  };

  if(id){ // modifica
    await set(ref(db, `terzisti/${id}`), data);
    showAlert("Record aggiornato!");
  } else { // nuovo
    await set(push(datiRef), data);
    showAlert("Dati inseriti con successo!");
  }

  e.target.reset();
  document.getElementById("editingId").value = "";
  setDefaultDate();
  loadTables();
  bootstrap.Modal.getInstance(document.getElementById("formModal")).hide();
});

// üîπ Imposta data di default oggi
function setDefaultDate(){
  const today = new Date();
  const gg = String(today.getDate()).padStart(2,'0');
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const yyyy = today.getFullYear();
  document.getElementById("dataInserimento").value = `${gg}/${mm}/${yyyy}`;
}

// üîπ Inizializza
loadTerzisti();
loadTables();
setDefaultDate();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
